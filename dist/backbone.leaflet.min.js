/*! backbone.leaflet - v0.0.1-dev - 7/7/2013
* http://github.com/LuizArmesto/backbone.leaflet
* Copyright (c) 2013 Luiz Armesto; Licensed MIT */
(function(e,t,n){"use strict";var r=e.$,i={};i.VERSION="0.0.1-dev";var s=e.Leaflet;e.Leaflet=i,i.noConflict=function(){return e.Leaflet=s,this};var o=i.GeoModel=e.Model.extend({set:function(n,r,i){var s,o,u,a;return s=arguments,typeof n=="object"&&(o=n,i=r),o&&o.type&&o.type==="Feature"&&(u=t.clone(o.properties)||{},a=t.clone(o.geometry)||null,a&&(a.coordinates=a.coordinates.slice()),u.geometry=a,s=[u,i]),e.Model.prototype.set.apply(this,s)},toJSON:function(e){var n,r,i;return e=e||{},n=t.clone(this.attributes),r=t.omit(n,"geometry"),e.cid&&(r.cid=this.cid),i=t.clone(n.geometry)||null,i&&(i.coordinates=i.coordinates.slice()),{type:"Feature",geometry:i,properties:r}}}),u=i.GeoCollection=e.Collection.extend({model:o,reset:function(n,r){return n&&!t.isArray(n)&&n.features&&(n=n.features),e.Collection.prototype.reset.apply(this,[n,r])},toJSON:function(t){var n=e.Collection.prototype.toJSON.apply(this,arguments);return{type:"FeatureCollection",features:n}}}),a=i.PopupView=function(t){e.View.apply(this,arguments),this.popup=new n.Popup(t)};a.extend=e.View.extend,t.extend(a.prototype,e.View.prototype,{template:t.template("<strong><%= properties.name %></strong><p><%= properties.description %></p>"),render:function(){return this.popup._content!==this.el&&this.popup.setContent(this.el),this.$el.html(this.template(this.model.toJSON())),this.popup._update(),this},setModel:function(e){return e&&(this.model&&this.stopListening(this.model),this.model=e,this.listenTo(e,"change",this.render)),this}});var f=function(e,t){var r=this._getModelByFeature(e);return new n.Marker(t,this.layerStyle(r))},l=function(e,t){var n=this._getModelByFeature(e);return this.modelFilter(n)},c=function(e){var t=this._getModelByFeature(e);return this.layerStyle(t)},h=function(e,n){this._layers[e.properties.cid]=n,n.cid=e.properties.cid;var r=["click","dblclick","mouseover","mouseout","contextmenu","dragstart","predrag","drag","dragend","move","add","remove","layeradd","layerremove"],i=this;t.each(r,function(e){n.on(e,function(t){var r=n._map;r.fire.apply(r,["layer_"+e].concat(arguments))})})},p=function(e){switch(e){case"marker":return"Point";case"polygon":case"rectangle":return"Polygon";case"polyline":return"LineString";default:throw new Error("GeoJSON don't allows "+e+" as geometry.")}},d=function(e,n){var r,i=[];return t.isFunction(e.getLatLngs)?r=e.getLatLngs():t.isFunction(e.getLatLng)&&(r=[e.getLatLng()]),t.each(r,function(e){i.push([e.lng,e.lat])}),n==="polygon"||n==="rectangle"?i=[i]:n==="marker"&&(i=i[0]),i},v=function(e,t){return{type:"Feature",geometry:{type:p(t),coordinates:d(e,t)},properties:{}}},m=/^(\S+)\s*(.*)$/,g=i.MapView=function(t){e.View.apply(this,arguments),this._ensureMap(),this._initDrawControl(),this._layers={},this._layer=this._getLayer(),this._layer.addTo(this.map);if(this.collection){if(!this.collection instanceof u)throw new Error('The "collection" option should be instance of "GeoCollection" to be used within Map view');this.listenTo(this.collection,"reset",this._onReset),this.listenTo(this.collection,"add",this._onAdd),this.listenTo(this.collection,"remove",this._onRemove),this.listenTo(this.collection,"change",this._onChange),this.redraw()}};g.extend=e.View.extend,t.extend(g.prototype,e.View.prototype,{defaultLayerOptions:{pointToLayer:f,filter:l,style:c,onEachFeature:h},defaultStyle:{},defaultMapOptions:{center:[-23.5,-46.6167],zoom:14,drawControl:n.Draw!=null},defaultPopupOptions:{},render:function(){this.map.invalidateSize()},redraw:function(){return this._layers={},this._layer.clearLayers(),this._layer.addData(this.collection.toJSON({cid:!0})),this},delegateEvents:function(n){this._ensureMap(),this._ensurePopup();var r="delegateEvents"+this.cid;e.View.prototype.delegateEvents.apply(this,arguments);if(!n&&!(n=t.result(this,"events")))return this;var i=function(e){return function(t){var n=t[0];e(n)}};this._leaflet_events={};for(var s in n){var o=n[s];t.isFunction(o)||(o=this[n[s]]);if(!o)throw new Error('Method "'+n[s]+'" does not exist');var u=s.match(m),a=u[1],f=u[2];o=t.bind(o,this);if(f==="map"||f==="layer")f==="layer"&&(a="layer_"+a,o=i(o)),this.map.on(a,o,r),this._leaflet_events[a]=o}return this},undelegateEvents:function(){var t="delegateEvents"+this.cid;return this.map.off(this._leaflet_events||{},t),this._leaflet_events=null,e.View.prototype.undelegateEvents.apply(this,arguments)},getTileLayer:function(){return new n.TileLayer("http:///{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png",{attribution:'Data, imagery and map information provided by <a href="http://www.mapquest.com/">MapQuest</a>, <a href="http://www.openstreetmap.org/">Open Street Map</a> and contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>.',subdomains:["otile1","otile2","otile3","otile4"]})},openPopup:function(e,t){this._ensurePopup();var r=this.collection.get(e),i=this._getLayerByModel(r);i.bindPopup(""),n.setOptions(this.popup,i._popup.options),i._popup=this.popup,t?this.popup.setContent(t):(this.popupView.setModel(r),this.popupView.render()),i.openPopup()},_ensurePopup:function(){if(!this.popup){this.popupOptions=t.defaults(this.options.popup||{},this.defaultPopupOptions);var e=this.options.popupView||a;this.popupView=new e(this.popupOptions),this.popup=this.popupView.popup}},_ensureMap:function(){if(this.map)return;this.mapOptions=t.defaults(this.options.map||{},this.defaultMapOptions),this.map=new n.Map(this.el,this.mapOptions),this.tileLayer=this.getTileLayer(),this.tileLayer.addTo(this.map)},_initDrawControl:function(){var e=this;if(n.Draw===null||!this.mapOptions.drawControl)return;this.map.on("draw:created",function(t){var n,r;e._layer.addLayer(t.layer),n=v(t.layer,t.layerType),r=new e.collection.model(n),t.layer.cid=r.cid,n.properties.cid=r.cid,h.apply(e,[n,t.layer]),e._updateLayerStyle(t.layer,r),e.collection.add(r)})},modelFilter:function(e){return e?this.options.filter&&t.isFunction(this.options.filter)?this.options.filter.apply(this,arguments):!this._layers[e.cid]:!0},layerStyle:function(e){return e?this.options.style?t.isFunction(this.options.style)?this.options.style.apply(this,arguments):this.options.style:e.getStyle&&t.isFunction(e.getStyle)?e.getStyle():this.defaultStyle:this.defaultStyle},_getModelByFeature:function(e){var n=t.where(this.collection.models,{cid:e.properties.cid});return n[0]},_getLayerByModel:function(e){return this._layers[e.cid]},_getLayer:function(){var e,r;return r=t.defaults(this.options.layer||{},this.defaultLayerOptions),e=["pointToLayer","filter","style","onEachFeature"],t.each(e,function(e){r[e]=t.bind(r[e],this)},this),new n.GeoJSON(null,r)},_onReset:function(){this.redraw()},_onAdd:function(e){if(this._getLayerByModel(e))return;this._layer.addData(e.toJSON({cid:!0}))},_onRemove:function(e){var t=this._layers[e.cid];t&&(this._layer.removeLayer(t),this._layers[e.cid]=null)},_onChange:function(e){var t,n=this._layers[e.cid];e.hasChanged("geometry")?(this._onRemove(e),this._onAdd(e)):this._updateLayerStyle(n,e)},_updateLayerStyle:function(e,n){var r=this.layerStyle(n);e.setStyle&&t.isFunction(e.setStyle)?e.setStyle(r):e.setIcon&&t.isFunction(e.setIcon)&&e.setOpacity&&t.isFunction(e.setOpacity)&&(r.icon&&e.setIcon(r.icon),r.opacity&&e.setOpacity(r.opacity))}});var y=i.SatelliteView=g.extend({defaultMapOptions:{center:[-23.5,-46.6167],zoom:11},getTileLayer:function(){return new n.TileLayer("http:///{s}.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.jpg",{attribution:'Data and imagery provided by <a href="http://www.mapquest.com/">MapQuest</a>. Portions Courtesy NASA/JPL-Caltech and U.S. Depart. of Agriculture, Farm Service Agency.',subdomains:["otile1","otile2","otile3","otile4"]})}})})(Backbone,_,L);